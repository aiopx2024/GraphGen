#!/usr/bin/env python3
"""
ç®€åŒ–ç‰ˆæº¯æºå·¥å…· - é’ˆå¯¹ç°æœ‰QAæ ¼å¼è¿›è¡Œåˆ†æ
"""

import json
import glob
import os
from datetime import datetime

def analyze_qa_file(qa_file_path: str):
    """åˆ†æQAæ–‡ä»¶çš„æº¯æºä¿¡æ¯"""
    
    with open(qa_file_path, 'r', encoding='utf-8') as f:
        qa_data = json.load(f)
    
    print(f"ğŸ“‚ åˆ†ææ–‡ä»¶: {qa_file_path}")
    print(f"ğŸ“Š QAæ•°æ®æ ¼å¼: {'ChatMLåˆ—è¡¨' if isinstance(qa_data, list) else 'å­—å…¸'}")
    print(f"ğŸ“ æ€»QAå¯¹æ•°é‡: {len(qa_data)}")
    
    # å¦‚æœæ˜¯ChatMLæ ¼å¼
    if isinstance(qa_data, list) and qa_data and "messages" in qa_data[0]:
        print("\nğŸ” ChatMLæ ¼å¼åˆ†æ:")
        print("   â€¢ è¿™äº›QAå¯¹ç›®å‰ç¼ºå°‘å®Œæ•´çš„æº¯æºmetadata")
        print("   â€¢ éœ€è¦ä½¿ç”¨å¢å¼ºçš„traverse_graph.pyæ¥ç”Ÿæˆå¸¦æº¯æºä¿¡æ¯çš„QA")
        
        # æ˜¾ç¤ºå‰å‡ ä¸ªQAå¯¹ç¤ºä¾‹
        print("\nğŸ“„ QAç¤ºä¾‹:")
        for i, item in enumerate(qa_data[:3]):
            user_msg = next((msg["content"] for msg in item["messages"] if msg["role"] == "user"), "")
            assistant_msg = next((msg["content"] for msg in item["messages"] if msg["role"] == "assistant"), "")
            print(f"   Q{i+1}: {user_msg[:100]}...")
            print(f"   A{i+1}: {assistant_msg[:100]}...")
            print()
    
    # æ£€æŸ¥æ˜¯å¦æœ‰metadata
    has_metadata = False
    if isinstance(qa_data, dict):
        for qa_id, qa_info in qa_data.items():
            if "metadata" in qa_info and "source_tracing" in qa_info["metadata"]:
                has_metadata = True
                break
    
    if has_metadata:
        print("âœ… å‘ç°å®Œæ•´çš„æº¯æºä¿¡æ¯ï¼")
    else:
        print("âŒ æœªå‘ç°æº¯æºmetadataï¼Œéœ€è¦é‡æ–°ç”ŸæˆQAä»¥è·å¾—å®Œæ•´è¿½è¸ªä¿¡æ¯")
    
    return {
        "file_path": qa_file_path,
        "qa_count": len(qa_data),
        "format": "ChatML" if isinstance(qa_data, list) else "dict",
        "has_metadata": has_metadata,
        "analysis_time": str(datetime.now())
    }

def main():
    print("ğŸ” GraphGen æº¯æºåˆ†æå·¥å…·")
    print("=" * 50)
    
    # æŸ¥æ‰¾QAæ–‡ä»¶
    qa_files = glob.glob("cache/data/graphgen/*/qa-*.json")
    if not qa_files:
        print("âŒ æœªæ‰¾åˆ°QAæ–‡ä»¶")
        return
    
    latest_file = max(qa_files, key=os.path.getctime)
    
    # åˆ†ææ–‡ä»¶
    result = analyze_qa_file(latest_file)
    
    # è¾“å‡ºå»ºè®®
    print("\nğŸ’¡ æº¯æºå®ç°å»ºè®®:")
    print("1. ğŸ“ å½“å‰ä»£ç å·²å¢å¼ºtraverse_graph.pyï¼Œæ·»åŠ äº†å®Œæ•´çš„æº¯æºæ”¯æŒ")
    print("2. ğŸ”„ é‡æ–°ç”ŸæˆQAå¯¹æ—¶å°†è‡ªåŠ¨åŒ…å«metadata.source_tracingä¿¡æ¯")
    print("3. ğŸ¯ æº¯æºæ˜ å°„åŒ…å«: åŸæ–‡æ¡£â†’æ–‡æœ¬å—â†’å®ä½“å…³ç³»â†’å­å›¾â†’QA")
    print("4. âœ… æ–°çš„QAæ ¼å¼å°†æ”¯æŒäº‹å®æ€§æ ¸éªŒ")
    
    # ä¿å­˜åˆ†ææŠ¥å‘Š
    report_path = latest_file.replace('.json', '_analysis_report.json')
    with open(report_path, 'w', encoding='utf-8') as f:
        json.dump(result, f, ensure_ascii=False, indent=2)
    
    print(f"\nğŸ“Š åˆ†ææŠ¥å‘Šå·²ä¿å­˜: {report_path}")

if __name__ == "__main__":
    main()